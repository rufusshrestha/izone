#!/bin/bash

# Configuration
# ---
IZONE_IP="http://192.168.1.130"
QUERY_URL="${IZONE_IP}/iZoneRequestV2"
COMMAND_URL="${IZONE_IP}/iZoneCommandV2"

# Define zones and their corresponding API indices.
# ---
declare -A ZONES=(
    ["kitchen"]=0
    ["theatre"]=1
    ["living"]=2
    ["master"]=3
    ["work"]=4
    ["guest"]=5
    ["rayden"]=6
    ["rumpus"]=7
)

# Global variable for verbose output
VERBOSE=false

# ANSI Color Codes
# ---
RED=$'\033[0;31m'
GREEN=$'\033[0;32m'
BLUE=$'\033[0;34m'
YELLOW=$'\033[0;33m'
WHITE=$'\033[1;37m' # Bold White for Fan/Vent
CYAN=$'\033[0;36m' # For Auto mode
ORANGE=$'\033[0;33m' # A slightly different yellow/orange for warnings
NC=$'\033[0m' # No Color (Reset)

# ---
# Helper Functions
# ---

# Function to send a command to the iZone system (silent by default)
send_command() {
    local data="$1"
    curl -s -XPOST "$COMMAND_URL" -H "Content-Type: application/json" --data "$data"
}

# Function to query the iZone system and return raw JSON
query_izone_raw() {
    local data="$1"
    curl -s "$QUERY_URL" -H "Content-Type: application/json" --data "$data"
}

# Function to format temperature (e.g., 2100 -> 21.0)
format_temp() {
    # If the input is empty or not a number, return as is.
    if [[ -z "$1" || ! "$1" =~ ^[0-9]+$ ]]; then
        echo "$1"
        return
    fi
    printf "%.1f" "$(echo "scale=1; $1 / 100" | bc)"
}

# ---
# Core Functions
# ---

# Get system-wide status and format selected details
get_system_status() {
    echo "--- System Status ---"
    local response=$(query_izone_raw '{ "iZoneV2Request": { "Type": 1, "No": 0, "No1": 0 } }')
    local sys_on=$(echo "$response" | jq -r '.SystemV2.SysOn')
    local sys_mode=$(echo "$response" | jq -r '.SystemV2.SysMode')
    local sys_temp=$(echo "$response" | jq -r '.SystemV2.Temp')
    local sys_setpoint=$(echo "$response" | jq -r '.SystemV2.Setpoint')
    local sys_fan=$(echo "$response" | jq -r '.SystemV2.SysFan')
    local ac_error=$(echo "$response" | jq -r '.SystemV2.ACError' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')

    local status_text=""
    if [[ "$sys_on" == "1" ]]; then
        status_text="${GREEN}ON${NC}"
    else
        status_text="${RED}OFF${NC}"
    fi

    local mode_text=""
    case "$sys_mode" in
        1) mode_text="${BLUE}Cool${NC}" ;;
        2) mode_text="${RED}Heat${NC}" ;;
        3) mode_text="${WHITE}Vent${NC}" ;;
        4) mode_text="${YELLOW}Dry${NC}" ;;
        5) mode_text="${CYAN}Auto${NC}" ;;
        6) mode_text="Exhaust" ;;
        7) mode_text="Pump Only" ;;
        *) mode_text="Mode($sys_mode)" ;;
    esac

    local fan_text="Unknown"
    case "$sys_fan" in
        1) fan_text="Low" ;;
        2) fan_text="Medium" ;;
        3) fan_text="High" ;;
        4) fan_text="Auto" ;;
        5) fan_text="Top" ;;
        99) fan_text="NonGasHeat" ;;
        *) fan_text="Fan($sys_fan)" ;;
    esac

    local error_text="$ac_error"
    if [[ "$ac_error" != "OK" ]]; then
        error_text="${RED}$ac_error${NC}" # Error in Red
    fi

    echo "System Status: ${status_text}"
    echo "Mode:          ${mode_text}"
    echo "Current Temp:  $(format_temp "$sys_temp")°C"
    echo "Setpoint:      $(format_temp "$sys_setpoint")°C"
    echo "Fan Speed:     ${fan_text}"
    echo "AC Error:      ${error_text}"
    echo "-------------------"

    if $VERBOSE; then
        echo "$response" | jq .
    fi
}

# Get system temperature only
get_system_temp() {
    echo "--- System Temperature ---"
    local response=$(query_izone_raw '{ "iZoneV2Request": { "Type": 1, "No": 0, "No1": 0 } }')
    local sys_temp=$(echo "$response" | jq -r '.SystemV2.Temp')
    echo "Current System Temperature: ${CYAN}$(format_temp "$sys_temp")°C${NC}"
    echo "--------------------------"
    if $VERBOSE; then
        echo "$response" | jq .
    fi
}

# Control or query a specific zone
control_zone() {
    local zone_name="$1"
    local action="$2"
    local zone_index="${ZONES[$zone_name]}"

    if [[ -z "$zone_index" ]]; then
        echo "${RED}Error: Unknown zone '${zone_name}'.${NC}"
        echo "Available zones: ${!ZONES[*]}"
        exit 1
    fi

    case "$action" in
        status|stat)
            echo "--- Zone Status: $(echo "$zone_name" | awk '{print toupper(substr($0,1,1))substr($0,2)}') ---"
            local response=$(query_izone_raw "{ \"iZoneV2Request\": { \"Type\": 2, \"No\": $zone_index, \"No1\": 0 } }")
            local name=$(echo "$response" | jq -r '.ZonesV2.Name')
            local mode=$(echo "$response" | jq -r '.ZonesV2.Mode')
            local setpoint=$(echo "$response" | jq -r '.ZonesV2.Setpoint')
            local temp=$(echo "$response" | jq -r '.ZonesV2.Temp')
            local damper_pos=$(echo "$response" | jq -r '.ZonesV2.DmpPos')

            local zone_mode_text=""
            if [[ "$mode" == "2" ]]; then
                zone_mode_text="${RED}OFF${NC}"
            elif [[ "$mode" == "3" ]]; then
                zone_mode_text="${GREEN}ON${NC}"
            else
                zone_mode_text="Unknown"
            fi

            echo "Zone:          ${name}"
            echo "Status:        ${zone_mode_text}"
            echo "Current Temp:  $(format_temp "$temp")°C"
            echo "Setpoint:      $(format_temp "$setpoint")°C"
            echo "Damper Pos:    ${damper_pos}%"
            echo "-------------------"
            if $VERBOSE; then
                echo "$response" | jq .
            fi
        ;;
        on)
            send_command "{\"ZoneMode\":{\"Index\":$zone_index,\"Mode\":3}}"
            echo "--- Zone Control ---"
            echo "Turned ${GREEN}ON${NC} zone: ${GREEN}$(echo "$zone_name" | awk '{print toupper(substr($0,1,1))substr($0,2)}')${NC}"
            echo "--------------------"
        ;;
        off)
            send_command "{\"ZoneMode\":{\"Index\":$zone_index,\"Mode\":2}}"
            echo "--- Zone Control ---"
            echo "Turned ${RED}OFF${NC} zone: ${RED}$(echo "$zone_name" | awk '{print toupper(substr($0,1,1))substr($0,2)}')${NC}"
            echo "--------------------"
        ;;
        temp|temperature)
            echo "--- Zone Temperature: $(echo "$zone_name" | awk '{print toupper(substr($0,1,1))substr($0,2)}') ---"
            local response=$(query_izone_raw "{ \"iZoneV2Request\": { \"Type\": 2, \"No\": $zone_index, \"No1\": 0 } }")
            local name=$(echo "$response" | jq -r '.ZonesV2.Name')
            local temp=$(echo "$response" | jq -r '.ZonesV2.Temp')
            echo "${name} Temperature: ${CYAN}$(format_temp "$temp")°C${NC}"
            echo "-----------------------------------"
            if $VERBOSE; then
                echo "$response" | jq .
            fi
        ;;
        *)
            echo "${RED}Invalid action for zone '${zone_name}'.${NC} Use 'status', 'on', 'off', or 'temp'."
            exit 1
        ;;
    esac
}

# Get summary of all zones
get_all_zones_summary() {
    echo "--- All Zones Summary ---"
    local all_zones_responses=""
    for zone_name in "${!ZONES[@]}"; do
        local zone_index="${ZONES[$zone_name]}"
        local response=$(query_izone_raw "{ \"iZoneV2Request\": { \"Type\": 2, \"No\": $zone_index, \"No1\": 0 } }")
        all_zones_responses+="$response"$'\n' # Append each zone's raw JSON response
        local name=$(echo "$response" | jq -r '.ZonesV2.Name')
        local mode=$(echo "$response" | jq -r '.ZonesV2.Mode')
        local temp=$(echo "$response" | jq -r '.ZonesV2.Temp')
        local setpoint=$(echo "$response" | jq -r '.ZonesV2.Setpoint')
        local damper_pos=$(echo "$response" | jq -r '.ZonesV2.DmpPos')

        local zone_mode_colored_text=""
        if [[ "$mode" == "2" ]]; then
            zone_mode_colored_text="${RED}OFF${NC}"
        elif [[ "$mode" == "3" ]]; then
            zone_mode_colored_text="${GREEN}ON${NC}"
        else
            zone_mode_colored_text="UNKNOWN"
        fi

        # Adjusted padding for the status column to account for color codes
        # Assuming max color code length + text length for 'OFF' = ~17 characters.
        printf "%-20s: %-17s Temp: %-5s°C Setpoint: %-5s°C Damper: %-3s%%\n" \
               "$(echo "$name" | sed 's/ /_/g')" \
               "${zone_mode_colored_text}" \
               "$(format_temp "$temp")" \
               "$(format_temp "$setpoint")" \
               "$damper_pos"
    done
    echo "-------------------------"
    if $VERBOSE; then
        echo "$all_zones_responses" | jq -s '.'
    fi
}


# ---
# Main Script Logic
# ---

# Parse for verbose flag
TEMP_ARGS=()
for arg in "$@"; do
    case "$arg" in
        -v|--verbose)
            VERBOSE=true
            ;;
        *)
            TEMP_ARGS+=("$arg")
            ;;
    esac
done
set -- "${TEMP_ARGS[@]}" # Replace original arguments with non-verbose arguments

# Check for correct number of arguments after processing verbose flag
if [[ $# -eq 0 ]]; then
    echo "Usage: ${CYAN}$0 <command> [zone_name] [action]${NC} ${YELLOW}[-v|--verbose]${NC}"
    echo ""
    echo "Commands:"
    echo "  ${GREEN}on${NC}                 - Turn on the entire AC system."
    echo "  ${RED}off${NC}                - Turn off the entire AC system."
    echo "  ${CYAN}status${NC}             - Get the overall system status (detailed)."
    echo "  ${CYAN}system_temp${NC}        - Get only the current system temperature."
    echo "  ${CYAN}zones_summary${NC}      - Get a summary of all zones."
    echo "  ${CYAN}<zone_name> <action>${NC} - Control a specific zone."
    echo ""
    echo "Zone Actions (for <zone_name>):"
    echo "  ${CYAN}status${NC}             - Get detailed status for the specified zone."
    echo "  ${GREEN}on${NC}                 - Turn on the specified zone."
    echo "  ${RED}off${NC}                - Turn off the specified zone."
    echo "  ${CYAN}temp${NC}               - Get only the current temperature for the specified zone."
    echo ""
    echo "Options:"
    echo "  ${YELLOW}-v, --verbose${NC}      - Show full JSON output for status queries."
    echo ""
    echo "Available zones: ${!ZONES[*]}"
    echo ""
    echo "Examples:"
    echo "  ${CYAN}$0 on${NC}"
    echo "  ${CYAN}$0 status${NC}"
    echo "  ${CYAN}$0 status -v${NC}"
    echo "  ${CYAN}$0 system_temp${NC}"
    echo "  ${CYAN}$0 zones_summary${NC}"
    echo "  ${CYAN}$0 zones_summary --verbose${NC}"
    echo "  ${CYAN}$0 kitchen on${NC}"
    echo "  ${CYAN}$0 living status -v${NC}"
    echo "  ${CYAN}$0 master temp${NC}"
    exit 1
fi

case "$1" in
    on|ON)
        send_command '{"SysOn":1}'
        echo "--- System Control ---"
        echo "AC system turned ${GREEN}ON${NC}."
        echo "--------------------"
    ;;
    off|OFF)
        send_command '{"SysOn":0}'
        echo "--- System Control ---"
        echo "AC system turned ${RED}OFF${NC}."
        echo "--------------------"
    ;;
    status|STATUS)
        get_system_status
    ;;
    system_temp)
        get_system_temp
    ;;
    zones_summary)
        get_all_zones_summary
    ;;
    *)
        zone_arg="${1,,}"
        if [[ -n "${ZONES[$zone_arg]}" && -n "$2" ]]; then
            control_zone "$zone_arg" "$2"
        else
            echo "${RED}Invalid command or missing zone action.${NC} Type '${CYAN}$0${NC}' for usage."
            exit 1
        fi
    ;;
esac
