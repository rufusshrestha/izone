#!/bin/bash

# Configuration
# ---
IZONE_IP="http://192.168.1.130"
QUERY_URL="${IZONE_IP}/iZoneRequestV2"
COMMAND_URL="${IZONE_IP}/iZoneCommandV2"

# Define zones and their corresponding API indices.
# ---
declare -A ZONES=(
    ["kitchen"]=0
    ["theatre"]=1
    ["living"]=2
    ["master"]=3
    ["work"]=4
    ["guest"]=5
    ["rayden"]=6
    ["rumpus"]=7
)

# Global variable for verbose output
VERBOSE=false

# ANSI Color Codes
# ---
RED=$'\033[0;31m'
GREEN=$'\033[0;32m'
BLUE=$'\033[0;34m'
YELLOW=$'\033[0;33m'
WHITE=$'\033[1;37m' # Bold White for Fan/Vent
CYAN=$'\033[0;36m' # For Auto mode, Temps
ORANGE=$'\033[0;33m' # For Warnings/Less critical errors
LIGHT_GRAY=$'\033[0;37m'
NC=$'\033[0m' # No Color (Reset)

# ---
# Helper Functions
# ---

# Function to send a command to the iZone system (silent by default)
send_command() {
    local data="$1"
    local response=$(curl -s -XPOST "$COMMAND_URL" -H "Content-Type: application/json" --data "$data")
    if [[ "$response" =~ "error" ]]; then
        echo "${RED}API Error: ${response}${NC}" >&2
        return 1
    fi
    if $VERBOSE; then
        echo "API Response: $response" | jq .
    fi
    return 0
}

# Function to query the iZone system and return raw JSON
query_izone_raw() {
    local data="$1"
    local response=$(curl -s "$QUERY_URL" -H "Content-Type: application/json" --data "$data")
    if [[ "$response" =~ "error" ]]; then
        echo "${RED}API Error: ${response}${NC}" >&2
        return "" # Return empty string on error
    fi
    echo "$response"
}

# Function to format temperature (e.g., 2100 -> 21.0)
format_temp() {
    # If the input is empty or not a number, return as is.
    if [[ -z "$1" || ! "$1" =~ ^[0-9]+$ ]]; then
        echo "$1"
        return
    fi
    printf "%.1f" "$(echo "scale=1; $1 / 100" | bc)"
}

# Function to convert raw mode integer to human-readable colored text
get_colored_system_mode() {
    local sys_mode="$1"
    case "$sys_mode" in
        1) echo "${BLUE}Cool${NC}" ;;
        2) echo "${RED}Heat${NC}" ;;
        3) echo "${WHITE}Vent${NC}" ;;
        4) echo "${YELLOW}Dry${NC}" ;;
        5) echo "${CYAN}Auto${NC}" ;;
        6) echo "Exhaust" ;; # No specific color for these, fallback to default
        7) echo "Pump Only" ;;
        *) echo "Mode($sys_mode)" ;;
    esac
}

# Function to convert raw fan integer to human-readable text
get_fan_speed_text() {
    local sys_fan="$1"
    case "$sys_fan" in
        1) echo "Low" ;;
        2) echo "Medium" ;;
        3) echo "High" ;;
        4) echo "Auto" ;;
        5) echo "Top" ;;
        99) echo "NonGasHeat" ;;
        *) echo "Fan($sys_fan)" ;;
    esac
}

# Function to convert ZoneType_e to human-readable text
get_zone_type_text() {
    local type_code="$1"
    case "$type_code" in
        1) echo "Open/Close" ;;
        2) echo "Constant" ;;
        3) echo "Auto" ;;
        *) echo "Type($type_code)" ;;
    esac
}

# Function to return the raw BatteryLevel_e value (no translation)
get_battery_level_text() {
    local batt_code="$1"
    # Optionally, you could still add color if the raw value is '0'
    if [[ "$batt_code" == "0" ]]; then
        echo "${RED}${batt_code}${NC}" # Still highlight '0' if it implies low/critical
    else
        echo "$batt_code"
    fi
}

# ---
# Core Functions
# ---

# Get system-wide status and format selected details
get_system_status() {
    echo "--- System Status ---"
    local response=$(query_izone_raw '{ "iZoneV2Request": { "Type": 1, "No": 0, "No1": 0 } }')
    if [[ -z "$response" ]]; then return 1; fi # Exit if query failed

    local sys_on=$(echo "$response" | jq -r '.SystemV2.SysOn')
    local sys_mode=$(echo "$response" | jq -r '.SystemV2.SysMode')
    local sys_temp=$(echo "$response" | jq -r '.SystemV2.Temp')
    local sys_setpoint=$(echo "$response" | jq -r '.SystemV2.Setpoint')
    local sys_fan=$(echo "$response" | jq -r '.SystemV2.SysFan')
    local ac_error=$(echo "$response" | jq -r '.SystemV2.ACError' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')

    local status_text=""
    if [[ "$sys_on" == "1" ]]; then
        status_text="${GREEN}ON${NC}"
    else
        status_text="${RED}OFF${NC}"
    fi

    local error_text="$ac_error"
    if [[ "$ac_error" != "OK" ]]; then
        error_text="${RED}$ac_error${NC}" # Error in Red
    fi

    echo "System Status: ${status_text}"
    echo "Mode:          $(get_colored_system_mode "$sys_mode")"
    echo "Current Temp:  ${CYAN}$(format_temp "$sys_temp")°C${NC}"
    echo "Setpoint:      $(format_temp "$sys_setpoint")°C"
    echo "Fan Speed:     $(get_fan_speed_text "$sys_fan")"
    echo "AC Error:      ${error_text}"
    echo "-------------------"

    if $VERBOSE; then
        echo "$response" | jq .
    fi
}

# Get system temperature only
get_system_temp() {
    echo "--- System Temperature ---"
    local response=$(query_izone_raw '{ "iZoneV2Request": { "Type": 1, "No": 0, "No1": 0 } }')
    if [[ -z "$response" ]]; then return 1; fi # Exit if query failed

    local sys_temp=$(echo "$response" | jq -r '.SystemV2.Temp')
    echo "Current System Temperature: ${CYAN}$(format_temp "$sys_temp")°C${NC}"
    echo "--------------------------"
    if $VERBOSE; then
        echo "$response" | jq .
    fi
}

# Control or query a specific zone
control_zone() {
    local zone_name="$1"
    local action="$2"
    local zone_index="${ZONES[$zone_name]}"

    if [[ -z "$zone_index" ]]; then
        echo "${RED}Error: Unknown zone '${zone_name}'.${NC}" >&2
        echo "Available zones: ${!ZONES[*]}" >&2
        exit 1
    fi

    # For display purposes in messages
    local capitalized_zone_name=$(echo "$zone_name" | awk '{print toupper(substr($0,1,1))substr($0,2)}')

    case "$action" in
        status|stat)
            echo "--- Zone Status: ${capitalized_zone_name} ---"
            local response=$(query_izone_raw "{ \"iZoneV2Request\": { \"Type\": 2, \"No\": $zone_index, \"No1\": 0 } }")
            if [[ -z "$response" ]]; then return 1; fi # Exit if query failed

            local name=$(echo "$response" | jq -r '.ZonesV2.Name')
            local mode=$(echo "$response" | jq -r '.ZonesV2.Mode')
            local setpoint=$(echo "$response" | jq -r '.ZonesV2.Setpoint')
            local temp=$(echo "$response" | jq -r '.ZonesV2.Temp')
            local damper_pos=$(echo "$response" | jq -r '.ZonesV2.DmpPos')
            local zone_type=$(echo "$response" | jq -r '.ZonesV2.ZoneType')
            local sens_type=$(echo "$response" | jq -r '.ZonesV2.SensType')
            local max_air=$(echo "$response" | jq -r '.ZonesV2.MaxAir')
            local min_air=$(echo "$response" | jq -r '.ZonesV2.MinAir')
            local const=$(echo "$response" | jq -r '.ZonesV2.Const')
            local const_a=$(echo "$response" | jq -r '.ZonesV2.ConstA')
            local master_zone=$(echo "$response" | jq -r '.ZonesV2.Master')
            local dmp_flt=$(echo "$response" | jq -r '.ZonesV2.DmpFlt')
            local isense=$(echo "$response" | jq -r '.ZonesV2.iSense')
            local area=$(echo "$response" | jq -r '.ZonesV2.Area')
            local calibration=$(echo "$response" | jq -r '.ZonesV2.Calibration')
            local bypass=$(echo "$response" | jq -r '.ZonesV2.Bypass')
            local rf_signal=$(echo "$response" | jq -r '.ZonesV2.RfSignal')
            local batt_volt=$(echo "$response" | jq -r '.ZonesV2.BattVolt')
            local sensor_fault=$(echo "$response" | jq -r '.ZonesV2.SensorFault')
            local balance_max=$(echo "$response" | jq -r '.ZonesV2.BalanceMax')
            local balance_min=$(echo "$response" | jq -r '.ZonesV2.BalanceMin')
            local damper_skip=$(echo "$response" | jq -r '.ZonesV2.DamperSkip')


            local zone_mode_text=""
            if [[ "$mode" == "2" ]]; then
                zone_mode_text="${RED}OFF${NC}"
            elif [[ "$mode" == "3" ]]; then
                zone_mode_text="${GREEN}ON${NC}"
            elif [[ "$mode" == "1" ]]; then # ZoneMode_Open
                zone_mode_text="${ORANGE}OPEN (Manual)${NC}"
            elif [[ "$mode" == "4" ]]; then # ZoneMode_Override
                zone_mode_text="${ORANGE}OVERRIDE${NC}"
            elif [[ "$mode" == "5" ]]; then # ZoneMode_Constant
                zone_mode_text="${ORANGE}CONSTANT${NC}"
            else
                zone_mode_text="Unknown (${mode})"
            fi

            local dmp_flt_text="${dmp_flt}"
            if [[ "$dmp_flt" == "1" ]]; then dmp_flt_text="${RED}FAULT${NC}"; fi
            local sensor_fault_text="${sensor_fault}"
            if [[ "$sensor_fault" == "1" ]]; then sensor_fault_text="${RED}FAULT${NC}"; fi

            echo "Zone Name:     ${name}"
            echo "Status:        ${zone_mode_text}"
            echo "Zone Type:     $(get_zone_type_text "$zone_type")"
            echo "Current Temp:  ${CYAN}$(format_temp "$temp")°C${NC}"
            echo "Setpoint:      $(format_temp "$setpoint")°C"
            echo "Damper Pos:    ${damper_pos}%"
            echo "Max Airflow:   ${max_air}%"
            echo "Min Airflow:   ${min_air}%"
            echo "--- Sensor & Faults ---"
            echo "Sensor Type:   ${sens_type}" # No lookup table provided for SensType_e
            echo "Sensor Fault:  ${sensor_fault_text}"
            echo "Damper Fault:  ${dmp_flt_text}"
            echo "iSense Active: ${isense}"
            echo "Calibration:   ${calibration}"
            echo "RF Signal:     ${rf_signal}" # No lookup table provided for RfSignalLevel_e
            echo "Battery:       $(get_battery_level_text "$batt_volt")"
            echo "--- Advanced ---"
            echo "Constant:      ${const}"
            echo "Constant Active: ${const_a}"
            echo "Master Zone:   ${master_zone}"
            echo "Area:          ${area}m²"
            echo "Bypass:        ${bypass}"
            echo "Balance Max:   ${balance_max}"
            echo "Balance Min:   ${balance_min}"
            echo "Damper Skip:   ${damper_skip}"
            echo "-------------------"
            if $VERBOSE; then
                echo "$response" | jq .
            fi
        ;;
        on)
            send_command "{\"ZoneMode\":{\"Index\":$zone_index,\"Mode\":3}}"
            echo "--- Zone Control ---"
            echo "Set zone ${capitalized_zone_name} to ${GREEN}ON (Auto Mode)${NC}."
            echo "--------------------"
        ;;
        off)
            send_command "{\"ZoneMode\":{\"Index\":$zone_index,\"Mode\":2}}"
            echo "--- Zone Control ---"
            echo "Set zone ${capitalized_zone_name} to ${RED}OFF (Close Mode)${NC}."
            echo "--------------------"
        ;;
        open) # New mode
            send_command "{\"ZoneMode\":{\"Index\":$zone_index,\"Mode\":1}}"
            echo "--- Zone Control ---"
            echo "Set zone ${capitalized_zone_name} to ${ORANGE}OPEN (Manual)${NC}."
            echo "--------------------"
        ;;
        auto) # New mode (same as 'on')
            send_command "{\"ZoneMode\":{\"Index\":$zone_index,\"Mode\":3}}"
            echo "--- Zone Control ---"
            echo "Set zone ${capitalized_zone_name} to ${GREEN}AUTO${NC}."
            echo "--------------------"
        ;;
        override) # New mode
            send_command "{\"ZoneMode\":{\"Index\":$zone_index,\"Mode\":4}}"
            echo "--- Zone Control ---"
            echo "Set zone ${capitalized_zone_name} to ${ORANGE}OVERRIDE${NC}."
            echo "--------------------"
        ;;
        constant) # New mode
            send_command "{\"ZoneMode\":{\"Index\":$zone_index,\"Mode\":5}}"
            echo "--- Zone Control ---"
            echo "Set zone ${capitalized_zone_name} to ${ORANGE}CONSTANT${NC}."
            echo "--------------------"
        ;;
        temp|temperature)
            echo "--- Zone Temperature: ${capitalized_zone_name} ---"
            local response=$(query_izone_raw "{ \"iZoneV2Request\": { \"Type\": 2, \"No\": $zone_index, \"No1\": 0 } }")
            if [[ -z "$response" ]]; then return 1; fi # Exit if query failed
            local name=$(echo "$response" | jq -r '.ZonesV2.Name')
            local temp=$(echo "$response" | jq -r '.ZonesV2.Temp')
            echo "${name} Temperature: ${CYAN}$(format_temp "$temp")°C${NC}"
            echo "-----------------------------------"
            if $VERBOSE; then
                echo "$response" | jq .
            fi
        ;;
        set_setpoint)
            local setpoint_raw="$3"
            if [[ -z "$setpoint_raw" ]]; then
                echo "${RED}Error: Missing setpoint temperature.${NC} Usage: ${CYAN}$0 ${zone_name} set_setpoint <temperature>${NC}" >&2
                exit 1
            fi
            # Convert float like 21.5 to int x100 (2150)
            local setpoint_int=$(echo "scale=0; $setpoint_raw * 100 / 1" | bc)
            # Validate range 1500 <= b <= 3000 (15.0C to 30.0C)
            if (( setpoint_int < 1500 || setpoint_int > 3000 )); then
                echo "${RED}Error: Setpoint temperature '$setpoint_raw' out of valid range (15.0-30.0°C).${NC}" >&2
                exit 1
            fi
            send_command "{\"ZoneSetpoint\":{\"Index\":$zone_index,\"Setpoint\":$setpoint_int}}"
            echo "--- Zone Control ---"
            echo "Set ${capitalized_zone_name} setpoint to ${CYAN}$(format_temp "$setpoint_int")°C${NC}."
            echo "--------------------"
        ;;
        set_max_air)
            local max_air="$3"
            if [[ -z "$max_air" ]]; then
                echo "${RED}Error: Missing maximum airflow percentage.${NC} Usage: ${CYAN}$0 ${zone_name} set_max_air <percentage>${NC}" >&2
                exit 1
            fi
            if ! [[ "$max_air" =~ ^[0-9]+$ ]] || (( max_air < 0 || max_air > 100 )); then
                echo "${RED}Error: Max airflow percentage '$max_air' invalid. Must be 0-100.${NC}" >&2
                exit 1
            fi
            send_command "{\"ZoneMaxAir\":{\"Index\":$zone_index,\"MaxAir\":$max_air}}"
            echo "--- Zone Control ---"
            echo "Set ${capitalized_zone_name} max airflow to ${max_air}%."
            echo "--------------------"
        ;;
        set_min_air)
            local min_air="$3"
            if [[ -z "$min_air" ]]; then
                echo "${RED}Error: Missing minimum airflow percentage.${NC} Usage: ${CYAN}$0 ${zone_name} set_min_air <percentage>${NC}" >&2
                exit 1
            fi
            if ! [[ "$min_air" =~ ^[0-9]+$ ]] || (( min_air < 0 || min_air > 100 )); then
                echo "${RED}Error: Min airflow percentage '$min_air' invalid. Must be 0-100.${NC}" >&2
                exit 1
            fi
            send_command "{\"ZoneMinAir\":{\"Index\":$zone_index,\"MinAir\":$min_air}}"
            echo "--- Zone Control ---"
            echo "Set ${capitalized_zone_name} min airflow to ${min_air}%."
            echo "--------------------"
        ;;
        set_name)
            local new_name="$3"
            if [[ -z "$new_name" ]]; then
                echo "${RED}Error: Missing new zone name.${NC} Usage: ${CYAN}$0 ${zone_name} set_name \"<new_name>\"${NC}" >&2
                exit 1
            fi
            if [[ "${#new_name}" -gt 15 ]]; then # Max length 15 characters
                echo "${RED}Error: New zone name '${new_name}' too long. Max 15 characters.${NC}" >&2
                exit 1
            fi
            send_command "{\"ZoneName\":{\"Index\":$zone_index,\"Name\":\"$new_name\"}}"
            echo "--- Zone Control ---"
            echo "Set ${capitalized_zone_name} name to '${GREEN}${new_name}${NC}'."
            echo "--------------------"
        ;;
        *)
            echo "${RED}Invalid action for zone '${zone_name}'.${NC}" >&2
            echo "Zone Actions: ${GREEN}on${NC}, ${RED}off${NC}, ${ORANGE}open${NC}, ${GREEN}auto${NC}, ${ORANGE}override${NC}, ${ORANGE}constant${NC}, ${CYAN}status${NC}, ${CYAN}temp${NC}, ${CYAN}set_setpoint${NC}, ${CYAN}set_max_air${NC}, ${CYAN}set_min_air${NC}, ${CYAN}set_name${NC}." >&2
            exit 1
        ;;
    esac
}

# Get summary of all zones
get_all_zones_summary() {
    echo "--- All Zones Summary ---"
    local all_zones_responses=""
    for zone_name in "${!ZONES[@]}"; do
        local zone_index="${ZONES[$zone_name]}"
        local response=$(query_izone_raw "{ \"iZoneV2Request\": { \"Type\": 2, \"No\": $zone_index, \"No1\": 0 } }")
        if [[ -z "$response" ]]; then
            printf "%-20s: ${RED}ERROR retrieving status${NC}\n" "$(echo "$zone_name" | sed 's/ /_/g')"
            continue
        fi

        all_zones_responses+="$response"$'\n'
        local name=$(echo "$response" | jq -r '.ZonesV2.Name')
        local mode=$(echo "$response" | jq -r '.ZonesV2.Mode')
        local temp=$(echo "$response" | jq -r '.ZonesV2.Temp')
        local setpoint=$(echo "$response" | jq -r '.ZonesV2.Setpoint')
        local damper_pos=$(echo "$response" | jq -r '.ZonesV2.DmpPos')
        local dmp_flt=$(echo "$response" | jq -r '.ZonesV2.DmpFlt')
        local sensor_fault=$(echo "$response" | jq -r '.ZonesV2.SensorFault')
        local batt_volt=$(echo "$response" | jq -r '.ZonesV2.BattVolt') # Assuming 0 is Low, 1 is OK

        local zone_mode_colored_text=""
        case "$mode" in
            1) zone_mode_colored_text="${ORANGE}OPEN${NC}" ;; # Added this line
            2) zone_mode_colored_text="${RED}OFF${NC}" ;;
            3) zone_mode_colored_text="${GREEN}ON${NC}" ;;
            4) zone_mode_colored_text="${ORANGE}OVRIDE${NC}" ;; # Abbreviated for summary
            5) zone_mode_colored_text="${ORANGE}CONST${NC}" ;; # Abbreviated for summary
            *) zone_mode_colored_text="UNKNOWN" ;;
        esac

        local additional_status=""
        if [[ "$dmp_flt" == "1" ]]; then
            additional_status+=" ${RED}DmpFlt${NC}"
        fi
        if [[ "$sensor_fault" == "1" ]]; then
            additional_status+=" ${RED}SnsFlt${NC}"
        fi
        if [[ "$batt_volt" == "0" ]]; then # Only highlight if raw value is '0'
            additional_status+=" ${RED}LowBatt${NC}"
        fi

        printf "%-20s: %-17s Temp: %-5s°C Setpoint: %-5s°C Damper: %-3s%% %s\n" \
               "$(echo "$name" | sed 's/ /_/g')" \
               "${zone_mode_colored_text}" \
               "$(format_temp "$temp")" \
               "$(format_temp "$setpoint")" \
               "$damper_pos" \
               "$additional_status"
    done
    echo "-------------------------"
    if $VERBOSE; then
        echo "$all_zones_responses" | jq -s '.'
    fi
}


# ---
# Main Script Logic
# ---

# Parse for verbose flag
TEMP_ARGS=()
for arg in "$@"; do
    case "$arg" in
        -v|--verbose)
            VERBOSE=true
            ;;
        *)
            TEMP_ARGS+=("$arg")
            ;;
    esac
done
set -- "${TEMP_ARGS[@]}" # Replace original arguments with non-verbose arguments

# Check for correct number of arguments after processing verbose flag
if [[ $# -eq 0 ]]; then
    echo "${GREEN}Airstream Control Script (v2.0)${NC}"
    echo "Usage: ${CYAN}$0 <command> [zone_name] [action_or_value]${NC} ${YELLOW}[-v|--verbose]${NC}"
    echo ""
    echo "${LIGHT_GRAY}System-wide Commands:${NC}"
    echo "  ${GREEN}on${NC}                 - Turn on the entire AC system."
    echo "  ${RED}off${NC}                - Turn off the entire AC system."
    echo "  ${CYAN}status${NC}             - Get the overall system status (detailed)."
    echo "  ${CYAN}system_temp${NC}        - Get only the current system temperature."
    echo "  ${CYAN}zones_summary${NC}      - Get a summary of all zones."
    echo ""
    echo "${LIGHT_GRAY}Zone-specific Commands:${NC}"
    echo "  ${CYAN}<zone_name> status${NC}      - Get detailed status for a specific zone."
    echo "  ${CYAN}<zone_name> temp${NC}        - Get only the current temperature for a specific zone."
    echo ""
    echo "${LIGHT_GRAY}Zone Control Actions (for <zone_name>):${NC}"
    echo "  ${GREEN}on${NC} / ${GREEN}auto${NC}       - Set zone to Auto mode (typically 'ON')."
    echo "  ${RED}off${NC}                 - Set zone to Close mode (typically 'OFF')."
    echo "  ${ORANGE}open${NC}              - Set zone to Open mode (manual open)."
    echo "  ${ORANGE}override${NC}          - Set zone to Override mode."
    echo "  ${ORANGE}constant${NC}          - Set zone to Constant mode."
    echo "  ${CYAN}set_setpoint <temp>${NC} - Set zone setpoint (e.g., 22.5)."
    echo "  ${CYAN}set_max_air <%>${NC}   - Set zone max airflow (e.g., 90)."
    echo "  ${CYAN}set_min_air <%>${NC}   - Set zone min airflow (e.g., 5)."
    echo "  ${CYAN}set_name \"<new_name>\"${NC} - Set zone name (max 15 chars)."
    echo ""
    echo "Options:"
    echo "  ${YELLOW}-v, --verbose${NC}      - Show full JSON output for status queries and API responses."
    echo ""
    echo "Available zones: ${!ZONES[*]}"
    echo ""
    echo "Examples:"
    echo "  ${CYAN}$0 status${NC}"
    echo "  ${CYAN}$0 zones_summary${NC}"
    echo "  ${CYAN}$0 master status${NC}"
    echo "  ${CYAN}$0 kitchen on${NC}"
    echo "  ${CYAN}$0 living set_setpoint 23.0${NC}"
    echo "  ${CYAN}$0 rayden set_name \"Rayden's Den\"${NC}"
    exit 1
fi

# Main command parsing
case "$1" in
    on|ON)
        send_command '{"SysOn":1}' && \
        echo "--- System Control ---" && \
        echo "AC system turned ${GREEN}ON${NC}." && \
        echo "--------------------"
    ;;
    off|OFF)
        send_command '{"SysOn":0}' && \
        echo "--- System Control ---" && \
        echo "AC system turned ${RED}OFF${NC}." && \
        echo "--------------------"
    ;;
    status|STATUS)
        get_system_status
    ;;
    system_temp)
        get_system_temp
    ;;
    zones_summary)
        get_all_zones_summary
    ;;
    *)
        zone_arg="${1,,}" # Convert to lowercase for case-insensitive matching
        if [[ -n "${ZONES[$zone_arg]}" ]]; then # Check if first arg is a valid zone name
            if [[ -z "$2" ]]; then # If no action specified for zone, show usage
                echo "${RED}Error: Missing action for zone '${zone_name}'.${NC}" >&2
                echo "Usage: ${CYAN}$0 <zone_name> <action> [value]${NC}" >&2
                echo "Zone Actions: ${GREEN}on${NC}, ${RED}off${NC}, ${ORANGE}open${NC}, ${GREEN}auto${NC}, ${ORANGE}override${NC}, ${ORANGE}constant${NC}, ${CYAN}status${NC}, ${CYAN}temp${NC}, ${CYAN}set_setpoint${NC}, ${CYAN}set_max_air${NC}, ${CYAN}set_min_air${NC}, ${CYAN}set_name${NC}." >&2
                exit 1
            fi
            control_zone "$zone_arg" "$2" "$3" # Pass all 3 args for actions that need a value
        else
            echo "${RED}Invalid command or zone name: '$1'.${NC}" >&2
            echo "Type '${CYAN}$0${NC}' for usage." >&2
            exit 1
        fi
    ;;
esac
